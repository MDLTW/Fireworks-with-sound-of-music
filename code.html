<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²è©©ç´šï¼1812åºæ›²ç…™ç«äº¤éŸ¿ç§€ (60ç§’å¾ªç’°)</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; }
        canvas { display: block; background-color: #000; }
        #sound-prompt {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.75); color: white; display: flex;
            justify-content: center; align-items: center; font-size: 2em;
            text-align: center; padding: 20px; box-sizing: border-box;
            cursor: pointer; z-index: 10;
        }
    </style>
</head>
<body>

    <div id="sound-prompt">
        ğŸ†<br>é»æ“Šè¢å¹•ä»»ä½•åœ°æ–¹<br>é–‹å•Ÿè²éŸ³ä¸¦é–‹å§‹ç…™ç«äº¤éŸ¿ç§€ï¼
    </div>

    <!-- è²éŸ³æª”æ¡ˆ -->
    <!-- *** éå¸¸é‡è¦ï¼šæŠŠä¸‹é¢ src å¼•è™Ÿè£¡çš„æª”åæ”¹æˆä½  GitHub audio è³‡æ–™å¤¾è£¡çš„çœŸå¯¦æª”åï¼*** -->
    <audio id="bgMusic" src="audio/tchaikovsky-1812.mp3" preload="auto" loop></audio>
    <audio id="fireworksSfxLoop" src="audio/fireworks-sfx.mp3" preload="auto" loop></audio>
    <!-- ************************************************************************** -->

    <canvas id="fireworksCanvas"></canvas>

    <script>
        const canvas = document.getElementById('fireworksCanvas');
        // *** å¦‚æœä¸Šé¢æ‰¾ä¸åˆ° canvasï¼Œé€™è£¡å°±æœƒå‡ºéŒ¯ï¼ ***
        if (!canvas) {
            console.error("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° ID ç‚º 'fireworksCanvas' çš„ <canvas> å…ƒç´ ï¼è«‹æª¢æŸ¥ HTMLã€‚");
        }
        const ctx = canvas ? canvas.getContext('2d') : null; // åŠ ä¸Šæª¢æŸ¥ï¼Œé¿å… canvas ä¸å­˜åœ¨æ™‚å‡ºéŒ¯
        let activeFireworks = [];
        let vw, vh;
        let mainLoopTimer = 0;
        let sequenceIndex = 0;
        let lastTime = 0;

        // --- è²éŸ³ç›¸é—œè®Šæ•¸ ---
        let bgMusic;
        let fireworksSfxLoop;
        let soundEnabled = false;
        let soundPrompt;

        // --- æ ¸å¿ƒè¨­å®š ---
        const sequenceDuration = 60000;
        const targetFireworksPerSequence = 800;
        const gravity = 0.03;
        const friction = 0.98;
        const trailLength = 8;

        // --- é¡è‰²åº« ---
        const colors = [
            '#FF4848', '#FF7648', '#FFA548', '#FFD048', '#FFFF48', '#48FFFF', '#48D1FF',
            '#48A5FF', '#4876FF', '#4848FF', '#7648FF', '#48FF48', '#48FF76', '#48FFA5',
            '#48FFD1', '#FF48FF', '#FF48D1', '#FF48A5', '#D148FF', '#A548FF', '#FFFFFF',
            '#F0F0F0', '#FFD700'
        ];

        // --- ç…™ç«é¡å‹ ---
        const fireworkTypes = [
            'sphere_mono', 'sphere_multi', 'sphere_rainbow', 'willow_gold', 'willow_multi',
            'glitter_fast', 'glitter_dense', 'strobe_mono', 'strobe_multi', 'ring_simple',
            'burst_directional', 'sphere_compact', 'sphere_large'
        ];

        // --- é ç”Ÿæˆåºåˆ— ---
        let fireworkSequence = [];
        function generateSequence() {
            console.log("Generating 60s firework sequence...");
            fireworkSequence = [];
            if (!vw || !vh) { resizeCanvas(); }
            for (let i = 0; i < targetFireworksPerSequence; i++) {
                const launchTime = Math.random() * sequenceDuration;
                const xPos = random(0.1, 0.9);
                const type = fireworkTypes[Math.floor(Math.random() * fireworkTypes.length)];
                const launchSpeed = random(-12, -16);
                const targetHeightFactor = random(0.15, 0.5);
                fireworkSequence.push({ time: launchTime, x: xPos, type: type, launchSpeed: launchSpeed, targetHeightFactor: targetHeightFactor });
            }
            fireworkSequence.sort((a, b) => a.time - b.time);
            console.log(`Generated ${fireworkSequence.length} firework events.`);
            sequenceIndex = 0;
        }

        // --- è¼”åŠ©å‡½æ•¸ ---
        function random(min, max) { return Math.random() * (max - min) + min; }
        function randomInt(min, max) { return Math.floor(random(min, max + 1)); }
        function randomColor(palette = colors) { return palette[Math.floor(Math.random() * palette.length)]; }
        function getColors(type) {
             let count = randomInt(1,3); let palette = colors;
             if (type.includes('mono')) count = 1;
             if (type.includes('multi')) count = randomInt(2, 4);
             if (type.includes('rainbow')) return ['#FF0000', '#FF7F00', '#FFFF00', '#00FF00', '#0000FF', '#4B0082', '#8B00FF'];
             if (type.includes('gold')) return ['#FFD700', '#FFA500', '#F0E68C'];
             const shuffled = palette.slice().sort(() => 0.5 - Math.random());
             return shuffled.slice(0, count);
        }

        // --- ç²’å­é¡åˆ¥ ---
        class Particle {
             constructor(x, y, vx, vy, color, life, particleType = 'normal', options = {}) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy; this.color = color;
                this.initialLife = life > 0 ? life : 0.1; this.life = this.initialLife; this.alpha = 1;
                this.type = particleType; this.gravity = gravity * (options.gravityFactor || 1);
                this.friction = options.friction || friction; this.strobeRate = options.strobeRate || 0.1;
                this.strobeIntensity = options.strobeIntensity || 0.5; this.radius = options.radius || random(1.5, 2.5);
                this.decay = random(0.01, 0.02) * (options.decayRate || 1);
                if (this.decay * (16.67) >= this.life && this.life > 0) { this.decay = this.life / 20 ; }
            }
             update(deltaTime) {
                 if (isNaN(deltaTime) || deltaTime <= 0) deltaTime = 16.67;
                 const dt = deltaTime / 16.67;
                 this.x += this.vx * dt; this.y += this.vy * dt; this.vy += this.gravity * dt;
                 this.vx *= Math.pow(this.friction, dt); this.vy *= Math.pow(this.friction, dt);
                 this.life -= this.decay * dt;
                 if (this.type === 'strobe') {
                     if (Math.random() < this.strobeRate) { this.alpha = random(1 - this.strobeIntensity, 1); }
                     else { const baseAlpha = this.initialLife > 0 ? Math.max(0, this.life / (this.initialLife * 0.5)) : 0; this.alpha = baseAlpha; }
                     this.alpha = Math.max(0, Math.min(1, this.alpha));
                 } else { this.alpha = this.initialLife > 0 ? Math.max(0, this.life / this.initialLife) : 0; }
                 this.alpha = Math.max(0, this.alpha);
             }
             draw() {
                 if (!ctx) return; // å¦‚æœæ‰¾ä¸åˆ°ç•«å¸ƒä¸Šä¸‹æ–‡ï¼Œå°±ä¸è¦ç•«
                 ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.beginPath();
                 ctx.arc(this.x, this.y, this.radius * this.alpha + 0.5, 0, Math.PI * 2); ctx.fill();
             }
             shouldRemove() { return this.life <= 0 || this.alpha <= 0.01; }
        }

        // --- ç…™ç«é¡åˆ¥ ---
        class Firework {
            constructor(startX, targetY, launchSpeed, type) {
                this.startX = startX; this.targetHeight = targetY; this.type = type; this.exploded = false;
                this.particles = []; this.rocket = { x: startX, y: vh, vx: random(-1, 1), vy: launchSpeed, alpha: 1, color: 'rgba(255,255,255,0.5)' };
                this.trailParticles = []; this.explosionParams = this.getExplosionParams(type); this.explosionColors = getColors(type);
            }
            getExplosionParams(type) {
                let p = { count: randomInt(80, 150), speed: random(3, 8), life: random(0.8, 1.8), particleType: 'normal', gravityFactor: 1, radius: random(1.5, 2.5), decayRate: 1, shape: 'sphere', angleRange: [0, Math.PI * 2] };
                if (type.includes('willow')){p.count=randomInt(60,120);p.speed=random(1,4);p.life=random(2.0,3.5);p.gravityFactor=1.2;p.decayRate=0.8;p.radius=random(1,2);}
                else if(type.includes('glitter')){p.count=randomInt(150,300);p.speed=random(4,9);p.life=random(0.3,0.8);p.decayRate=1.5;p.radius=random(0.8,1.5);}
                else if(type.includes('strobe')){p.particleType='strobe';p.life=random(0.6,1.5);p.strobeRate=0.2;p.strobeIntensity=0.6;}
                else if(type.includes('ring')){p.shape='ring';const s=Math.random()*Math.PI*2;const w=random(Math.PI*0.1,Math.PI*0.3);p.angleRange=[s,s+w];p.count=randomInt(100,180);p.speed=random(4,7);}
                else if(type.includes('directional')){p.shape='directional';const d=Math.random()*Math.PI*2;const sp=random(Math.PI*0.3,Math.PI*0.8);p.angleRange=[d-sp/2,d+sp/2];p.speed=random(6,11);}
                if(type.includes('compact')){p.speed=random(2,5);p.life=random(0.6,1.2);p.count=randomInt(60,100);}
                if(type.includes('large')){p.speed=random(5,10);p.life=random(1.5,2.5);p.count=randomInt(120,200);}
                return p;
            }
            update(deltaTime) {
                const dt = deltaTime / 16.67;
                if (!this.exploded) {
                    this.rocket.x += this.rocket.vx*dt; this.rocket.y += this.rocket.vy*dt; this.rocket.vy += gravity*dt;
                    if(Math.random()<0.5){this.trailParticles.push(new Particle(this.rocket.x,this.rocket.y,random(-0.3,0.3),random(-0.3,0.3),this.rocket.color,random(0.3,0.7),'normal',{radius:1.5,decayRate:1.8}));}
                    if (this.rocket.y <= this.targetHeight || this.rocket.vy >= -1) { this.explode(); }
                }
                for(let i=this.particles.length-1;i>=0;i--){this.particles[i].update(deltaTime);if(this.particles[i].shouldRemove()){this.particles.splice(i,1);}}
                for(let i=this.trailParticles.length-1;i>=0;i--){this.trailParticles[i].update(deltaTime);if(this.trailParticles[i].shouldRemove()){this.trailParticles.splice(i,1);}}
            }
            explode() {
                if(this.exploded)return; this.exploded=true; this.rocket.alpha=0;
                const ex=this.rocket.x; const ey=this.rocket.y; const p=this.explosionParams;
                for(let i=0;i<p.count;i++){
                    let a; if(p.shape==='sphere'){a=Math.random()*Math.PI*2;}else if(p.shape==='ring'){a=p.angleRange[0]+Math.random()*(p.angleRange[1]-p.angleRange[0]);}else if(p.shape==='directional'){a=p.angleRange[0]+Math.random()*(p.angleRange[1]-p.angleRange[0]);}else{a=Math.random()*Math.PI*2;}
                    const sp=random(0.5,1.0)*p.speed*(Math.random()>0.9?1.5:1); const vx=Math.cos(a)*sp; const vy=Math.sin(a)*sp;
                    const c=this.explosionColors.length>0?this.explosionColors[i%this.explosionColors.length]:randomColor(); const l=random(0.8,1.2)*p.life;
                    this.particles.push(new Particle(ex,ey,vx,vy,c,l,p.particleType,{gravityFactor:p.gravityFactor,radius:p.radius,decayRate:p.decayRate,strobeRate:p.strobeRate,strobeIntensity:p.strobeIntensity}));
                }
                this.trailParticles.forEach(pt=>{pt.life*=0.5;});
            }
            draw() {
                 if (!ctx) return;
                 ctx.globalAlpha=0.6; this.trailParticles.forEach(p=>p.draw());
                 ctx.globalAlpha=1; this.particles.forEach(p=>p.draw()); ctx.globalAlpha=1;
            }
            shouldRemove() { return this.exploded && this.particles.length === 0 && this.trailParticles.length === 0; }
        }

        // --- ä¸»å‹•ç•«å¾ªç’° ---
        function animate(currentTime) {
             requestAnimationFrame(animate);
             if (!ctx) return; // å¦‚æœæ²’æœ‰ç•«å¸ƒä¸Šä¸‹æ–‡ï¼Œåœæ­¢å‹•ç•«
             if (!lastTime) lastTime = currentTime;
             const deltaTime = currentTime - lastTime; lastTime = currentTime;
             if (isNaN(deltaTime) || deltaTime <= 0 || deltaTime > 100) { return; }

             if (soundEnabled) {
                mainLoopTimer += deltaTime;
                if (mainLoopTimer >= sequenceDuration) {
                    console.log("å¾ªç’°æ’­æ”¾..."); mainLoopTimer %= sequenceDuration; sequenceIndex = 0;
                    if(bgMusic){try{bgMusic.currentTime=0;if(bgMusic.paused)bgMusic.play();}catch(e){console.warn("ç„¡æ³•é‡ç½®èƒŒæ™¯éŸ³æ¨‚:",e);}}
                    if(fireworksSfxLoop){try{fireworksSfxLoop.currentTime=0;if(fireworksSfxLoop.paused)fireworksSfxLoop.play();}catch(e){console.warn("ç„¡æ³•é‡ç½®ç…™ç«éŸ³æ•ˆ:",e);}}
                }
                while (sequenceIndex < fireworkSequence.length && fireworkSequence[sequenceIndex].time <= mainLoopTimer) {
                    const e = fireworkSequence[sequenceIndex]; const x = e.x*vw; const y = vh*e.targetHeightFactor;
                    if(x>0&&x<vw){activeFireworks.push(new Firework(x,y,e.launchSpeed,e.type));} sequenceIndex++;
                }
             }

             ctx.fillStyle = `rgba(0, 0, 0, ${trailLength / 100})`; ctx.globalCompositeOperation = 'source-over'; ctx.fillRect(0, 0, vw, vh);
             ctx.globalCompositeOperation = 'lighter';
             for(let i=activeFireworks.length-1;i>=0;i--){activeFireworks[i].update(deltaTime);activeFireworks[i].draw();if(activeFireworks[i].shouldRemove()){activeFireworks.splice(i,1);}}
             ctx.globalCompositeOperation = 'source-over'; ctx.globalAlpha = 1;
        }

        // --- åˆå§‹åŒ–è²éŸ³ ---
        function initAudio() {
            soundPrompt = document.getElementById('sound-prompt');
            bgMusic = document.getElementById('bgMusic');
            fireworksSfxLoop = document.getElementById('fireworksSfxLoop');
            if(bgMusic){bgMusic.volume=1.0;console.log("èƒŒæ™¯éŸ³æ¨‚å…ƒç´ æ‰¾åˆ°ï¼ŒéŸ³é‡è¨­å®šç‚º 1.0");}else{console.error("æ‰¾ä¸åˆ°èƒŒæ™¯éŸ³æ¨‚å…ƒç´  #bgMusic");}
            if(fireworksSfxLoop){fireworksSfxLoop.volume=1.0;console.log("ç…™ç«éŸ³æ•ˆå…ƒç´ æ‰¾åˆ°ï¼ŒéŸ³é‡è¨­å®šç‚º 1.0");}else{console.error("æ‰¾ä¸åˆ°ç…™ç«éŸ³æ•ˆå…ƒç´  #fireworksSfxLoop");}
            if(soundPrompt) { // åŠ ä¸Šæª¢æŸ¥ï¼Œé¿å… soundPrompt ä¸å­˜åœ¨æ™‚å‡ºéŒ¯
                 soundPrompt.addEventListener('click', enableSound, { once: true });
            } else {
                 console.warn("æ‰¾ä¸åˆ° ID ç‚º 'sound-prompt' çš„å…ƒç´ ï¼Œè«‹æª¢æŸ¥ HTMLã€‚å°‡å˜—è©¦ç›£è½ body é»æ“Šã€‚");
                 // å‚™ç”¨æ–¹æ¡ˆï¼šå¦‚æœæç¤º div æ‰¾ä¸åˆ°ï¼Œå°±ç›£è½æ•´å€‹ body çš„é»æ“Š
                 document.body.addEventListener('click', enableSound, { once: true });
            }
        }

        // --- å•Ÿç”¨è²éŸ³çš„å‡½æ•¸ ---
        function enableSound() {
             if(soundEnabled)return; console.log("è²éŸ³å·²ç”±ä½¿ç”¨è€…äº’å‹•å•Ÿç”¨ã€‚"); soundEnabled=true;
             if(soundPrompt) soundPrompt.style.display='none'; // éš±è—æç¤º
             const playPromises=[];
             if(bgMusic){playPromises.push(bgMusic.play().catch(e => console.error("èƒŒæ™¯éŸ³æ¨‚æ’­æ”¾å¤±æ•—:", e)));} // åŠ ä¸Š catch é¿å…ä¸­æ–· Promise.all
             if(fireworksSfxLoop){playPromises.push(fireworksSfxLoop.play().catch(e => console.error("ç…™ç«éŸ³æ•ˆæ’­æ”¾å¤±æ•—:", e)));}
             Promise.all(playPromises)
                .then(() => { console.log("èƒŒæ™¯éŸ³æ¨‚å’Œç…™ç«éŸ³æ•ˆå˜—è©¦é–‹å§‹æ’­æ”¾ã€‚"); mainLoopTimer=0; sequenceIndex=0; lastTime=performance.now(); console.log("ä¸»å¾ªç’°è¨ˆæ™‚å™¨å·²é‡ç½®èˆ‡è²éŸ³åŒæ­¥ã€‚"); })
                .catch(e => { console.error("è‡³å°‘ä¸€å€‹è²éŸ³æ’­æ”¾ Promise è¢«æ‹’çµ• (å¯èƒ½æ˜¯å› ç‚ºæ’­æ”¾å¤±æ•—):", e); mainLoopTimer=0; sequenceIndex=0; lastTime=performance.now(); console.warn("å„˜ç®¡è²éŸ³æ’­æ”¾å¯èƒ½å¤±æ•—ï¼Œä¸»å¾ªç’°è¨ˆæ™‚å™¨ä»å·²é‡ç½®ã€‚"); });
        }

        // --- é‡è¨­ç•«å¸ƒå¤§å°å‡½æ•¸ ---
        function resizeCanvas() {
            if (!canvas) return; // å¦‚æœæ‰¾ä¸åˆ°ç•«å¸ƒï¼Œä¸åŸ·è¡Œ
            vw = canvas.width = window.innerWidth; vh = canvas.height = window.innerHeight;
        }

        // --- åˆå§‹åŒ–è¨­å®š ---
        function setup() {
             resizeCanvas();
             if (!ctx) { // å¦‚æœç„¡æ³•å–å¾—ç•«å¸ƒä¸Šä¸‹æ–‡ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ä¸¦åœæ­¢
                 document.body.innerHTML = '<p style="color:red; text-align:center; padding-top: 50px; font-size:1.5em;">éŒ¯èª¤ï¼šç„¡æ³•åˆå§‹åŒ– Canvasï¼<br>å¯èƒ½æ˜¯å› ç‚º HTML ä¸­ç¼ºå°‘ ID ç‚º "fireworksCanvas" çš„ &lt;canvas&gt; å…ƒç´ ã€‚</p>';
                 return;
             }
             generateSequence();
             initAudio();
             requestAnimationFrame(animate);
             console.log("è¨­å®šå®Œæˆï¼Œç­‰å¾…ä½¿ç”¨è€…äº’å‹•ä»¥å•Ÿç”¨è²éŸ³ã€‚");
        }

        // --- äº‹ä»¶ç›£è½ (çª—å£å¤§å°æ”¹è®Š) ---
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
             resizeTimeout = setTimeout(() => {
                console.log("çª—å£å¤§å°æ”¹è®Š - é‡æ–°ç”Ÿæˆåºåˆ—..."); resizeCanvas(); generateSequence();
                if(soundEnabled){ mainLoopTimer=0; lastTime=performance.now(); sequenceIndex=0;
                if(bgMusic&&!bgMusic.paused){bgMusic.currentTime=0;} if(fireworksSfxLoop&&!fireworksSfxLoop.paused){fireworksSfxLoop.currentTime=0;} }
             }, 500);
        });

        // å•Ÿå‹•ï¼
        setup();
    </script>

</body>
</html>